default:
  context:
    node_name: '@node'
    node: 'cleanWater'
    visitor: 'ant'

ml_title_where:
  src: "nodes where title like 'Etat%' in site"
  sql: "%Q{SELECT nodes.* FROM idx_nodes_ml_strings,nodes WHERE #{secure_scope('nodes')} AND idx_nodes_ml_strings.value LIKE 'Etat%' AND idx_nodes_ml_strings.lang = 'fr' AND idx_nodes_ml_strings.key = 'title' AND idx_nodes_ml_strings.node_id = nodes.id GROUP BY nodes.id ORDER BY nodes.position ASC, nodes.node_name ASC}"
  res: 'status'

ml_title_where_with_or:
  src: "nodes where title like 'Etat%' or class = Letter in site"
  sql: "%Q{SELECT nodes.* FROM idx_nodes_ml_strings,nodes WHERE #{secure_scope('nodes')} AND ((idx_nodes_ml_strings.value LIKE 'Etat%' AND idx_nodes_ml_strings.lang = 'fr' AND idx_nodes_ml_strings.key = 'title' AND idx_nodes_ml_strings.node_id = nodes.id) OR (nodes.kpath = 'NNL' AND idx_nodes_ml_strings.id = 0)) GROUP BY nodes.id ORDER BY nodes.position ASC, nodes.node_name ASC}"
  res: 'status, letter'

name_where:
  src: "base_contacts where name like 'Inv%' in site"
  sql: "%Q{SELECT nodes.* FROM idx_nodes_strings,nodes WHERE #{secure_scope('nodes')} AND idx_nodes_strings.value LIKE 'Inv%' AND idx_nodes_strings.key = 'name' AND idx_nodes_strings.node_id = nodes.id AND nodes.kpath LIKE 'NRC%' GROUP BY nodes.id ORDER BY nodes.position ASC, nodes.node_name ASC}"
  res: 'ant'

# TODO: Only implement with a proper use case. Ref [#190]
#       this is really more complex then it seems if we do not want too bad performance. Easiest way:
#       NOT EXISTS (SELECT 'x' FROM idx_nodes_ml_strings AS im WHERE im.node_id = nodes.id AND im.key = 'title' AND im.lang = 'fr')
# indexed_value_is_null:
#   src: "projects where title is null in site"
#   sql: "%Q{SELECT nodes.* FROM idx_nodes_ml_strings,nodes WHERE #{secure_scope('nodes')} AND idx_nodes_ml_strings.value IS NULL AND idx_nodes_ml_strings.key = 'title' AND idx_nodes_ml_strings.node_id = nodes.id AND nodes.kpath LIKE 'NPP%' GROUP BY nodes.id ORDER BY nodes.position ASC, nodes.node_name ASC}"
#   res: "wiki, zena"

ml_title_order:
  context:
    node: 'cleanWater'
  src: "pages in site order by title asc limit 7"
  sql: "%Q{SELECT nodes.* FROM idx_nodes_ml_strings,nodes WHERE #{secure_scope('nodes')} AND idx_nodes_ml_strings.lang = 'fr' AND idx_nodes_ml_strings.key = 'title' AND idx_nodes_ml_strings.node_id = nodes.id AND nodes.kpath LIKE 'NP%' GROUP BY nodes.id ORDER BY idx_nodes_ml_strings.value ASC LIMIT 7}"
  res: "wiki, art, cleanWater, collections, crocodiles, default, status"


dynattr_filter_in_relation:
  src: "favorites where d_priority = 'important'"
  sql: "[%Q{SELECT nodes.*,links.id AS link_id,links.status AS l_status,links.comment AS l_comment,links.date AS l_date FROM nodes,versions LEFT JOIN dyn_attributes ON versions.id = dyn_attributes.owner_id AND dyn_attributes.key = 'priority',links WHERE #{secure_scope('nodes')} AND nodes.id = links.target_id AND links.relation_id = _ID(contact_has_favorites) AND links.source_id = ? AND dyn_attributes.value = 'important' AND nodes.id = versions.node_id GROUP BY nodes.id ORDER BY nodes.position ASC, nodes.node_name ASC}, @node.id]"
  res: ""
